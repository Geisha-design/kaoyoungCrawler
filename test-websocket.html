<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket æµ‹è¯• - ç«¯å£8090</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .log {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
        }
        input[type="text"] {
            width: 300px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket è¿æ¥æµ‹è¯• - ç«¯å£8090</h1>
        <div>
            <label for="token">JWT Token:</label>
            <input type="text" id="token" placeholder="è¯·è¾“å…¥æœ‰æ•ˆçš„JWT token">
            <button onclick="connect()">è¿æ¥</button>
            <button onclick="disconnect()">æ–­å¼€</button>
        </div>
        <div>
            <label for="testToken">æµ‹è¯•Token:</label>
            <input type="text" id="testToken" placeholder="è¾“å…¥è¦æµ‹è¯•çš„token">
            <button onclick="testToken()">æµ‹è¯•Token</button>
        </div>
        <div>
            <p>å½“å‰WebSocket URL: <strong>ws://localhost:8090/smarteCrawler/ws?token=[TOKEN]</strong></p>
        </div>
        <div class="log" id="log"></div>
    </div>

    <script>
        let ws = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function connect() {
            const tokenInput = document.getElementById('token');
            const token = tokenInput.value.trim();

            if (!token) {
                alert('è¯·è¾“å…¥JWT token');
                return;
            }

            try {
                // ä½¿ç”¨æ–°ç«¯å£8090å’Œæ­£ç¡®çš„è·¯å¾„å‰ç¼€
                const wsUrl = `ws://localhost:8090/smarteCrawler/ws?token=${encodeURIComponent(token)}`;
                log(`å°è¯•è¿æ¥åˆ°: ${wsUrl}`);

                ws = new WebSocket(wsUrl);

                ws.onopen = function(event) {
                    log('âœ… WebSocketè¿æ¥å·²å»ºç«‹');
                };

                ws.onmessage = function(event) {
                    log('ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ' + event.data);
                };

                ws.onclose = function(event) {
                    log(`âŒ WebSocketè¿æ¥å·²å…³é—­: ${event.code} - ${event.reason}`);
                };

                ws.onerror = function(error) {
                    log('ğŸš¨ WebSocketé”™è¯¯: ' + error);
                };
            } catch (error) {
                log('è¿æ¥é”™è¯¯: ' + error.message);
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        async function testToken() {
            try {
                // ä½¿ç”¨fetchè¯·æ±‚ç™»å½•æ¥å£æ¥è·å–æœ‰æ•ˆtoken
                const response = await fetch('http://localhost:8090/smarteCrawler/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: '123456'
                    })
                });

                const result = await response.json();
                log(`ç™»å½•å“åº”: ${JSON.stringify(result)}`);
                
                if (result.code === 200) {
                    document.getElementById('token').value = result.data.token;
                    log('å·²å¡«å…¥æœ‰æ•ˆtokenï¼Œè¯·ç‚¹å‡»"è¿æ¥"æŒ‰é’®è¿›è¡Œæµ‹è¯•');
                } else {
                    log('ç™»å½•å¤±è´¥ï¼Œæ— æ³•è·å–æœ‰æ•ˆtoken');
                }
            } catch (error) {
                log('è·å–tokenå¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>