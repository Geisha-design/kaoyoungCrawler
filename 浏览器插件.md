# 浏览器扩展客户端技术说明文档

## 1. 概述

浏览器扩展客户端是爬虫助手系统的重要组成部分，负责在用户浏览器中执行爬取任务、与后端服务器通信，并管理客户端状态。该扩展采用现代浏览器扩展技术，支持实时通信、任务调度和空闲检测等功能。

## 2. 架构组成

### 2.1 文件结构
```
browser_extension/
├── manifest.json           # 扩展配置文件
├── background.js          # 后台服务脚本
├── content.js             # 内容脚本
├── login.js               # 登录管理脚本
├── task-manager.js        # 任务管理脚本
├── popup.html             # 弹出窗口界面
├── task-manager.html      # 任务管理界面
├── README.md              # 使用说明
└── icons/                 # 图标资源
```


### 2.2 核心组件

#### 2.2.1 Manifest配置 (manifest.json)
```json
{
  "manifest_version": 3,
  "name": "爬虫助手",
  "version": "1.0.0",
  "permissions": ["storage", "tabs", "alarms"],
  "host_permissions": ["<all_urls>"],
  "background": {
    "service_worker": "background.js"
  },
  "content_scripts": [
    {
      "matches": ["<all_urls>"],
      "js": ["content.js"]
    }
  ],
  "action": {
    "default_popup": "popup.html"
  }
}
```


## 3. 功能模块详解

### 3.1 客户端身份管理

#### 3.1.1 身份标识生成
客户端ID通过浏览器指纹技术生成，包含以下特征：
- 运行时ID (`chrome.runtime.id`)
- 用户代理 (`navigator.userAgent`)
- 语言设置 (`navigator.language`)
- 平台信息 (`navigator.platform`)
- 屏幕分辨率 (`screen.width x screen.height x screen.colorDepth`)
- 时区信息 (`Intl.DateTimeFormat().resolvedOptions().timeZone`)
- 存储支持检测 (localStorage, sessionStorage, indexedDB)
- GPU信息 (WebGL渲染器和供应商)

#### 3.1.2 ID生成算法
```javascript
async function generateBrowserFingerprint() {
  const components = [];
  
  // 收集浏览器特征
  components.push(chrome.runtime.id || Math.random().toString(36).substring(2, 15));
  components.push(navigator.userAgent);
  components.push(navigator.language);
  // ... 其他特征收集
  
  // 生成哈希
  const combinedString = components.join('||');
  let hash = 0;
  for (let i = 0; i < combinedString.length; i++) {
    const char = combinedString.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // 转换为32位整数
  }
  
  return `client_fp_${Math.abs(hash).toString(36)}`;
}
```


### 3.2 WebSocket通信模块

#### 3.2.1 连接管理
- **连接建立**: 通过JWT令牌进行身份验证
- **心跳机制**: 每30秒发送心跳包维持连接
- **断线重连**: 自动重连机制确保连接稳定性
- **消息协议**: 支持认证、注册、任务指令等多种消息类型

#### 3.2.2 消息类型
| 消息类型 | 说明 |
|---------|------|
| `auth_success` | 认证成功响应 |
| [register](file:///Users/qiyuzheng/Desktop/java_project/kaoyoungCrawler/src/main/java/smartebao/guide/controller/LoginController.java#L93-L139) | 客户端注册消息 |
| `heartbeat` | 心跳消息 |
| `execute_script` | 脚本执行指令 |
| `crawl_result` | 爬取结果上传 |

### 3.3 用户界面模块

#### 3.3.1 弹出窗口 (popup.html)
- **登录界面**: 用户认证入口
- **连接状态**: 显示WebSocket连接状态
- **客户端信息**: 展示客户端ID、用户名、当前页面
- **操作按钮**: 提供登录、退出、复制ID等功能

#### 3.3.2 任务管理器 (task-manager.html)
- **任务列表**: 显示定时任务配置
- **任务操作**: 支持创建、编辑、删除、启用/禁用任务
- **同步机制**: 与后端服务保持任务配置同步

### 3.4 内容脚本模块

#### 3.4.1 页面上下文操作
- **脚本执行**: 在当前页面上下文中执行爬取脚本
- **DOM操作**: 直接访问和操作页面DOM元素
- **结果收集**: 提取页面数据并发送回后台服务

#### 3.4.2 用户活动监控
- **事件监听**: 监听鼠标、键盘、滚动等用户活动事件
- **空闲检测**: 检测用户无活动状态，支持后台任务执行
- **状态上报**: 向后台服务报告用户活动状态

### 3.5 脚本管理模块

#### 3.5.1 脚本缓存
- **本地缓存**: 将服务器推送的爬取脚本缓存在内存中
- **域名匹配**: 建立域名与爬取脚本的映射关系
- **自动执行**: 当访问匹配域名时自动执行相关脚本

#### 3.5.2 脚本执行引擎
- **安全执行**: 使用Function构造器替代eval确保安全
- **错误处理**: 捕获脚本执行错误并上报
- **结果处理**: 格式化爬取结果并发送回服务器

## 4. 工作流程

### 4.1 正常工作流程
1. **扩展启动**: 加载时初始化客户端ID
2. **用户登录**: 输入凭据并生成新的客户端ID
3. **连接建立**: 通过WebSocket连接后端服务器
4. **身份认证**: 使用JWT令牌完成身份验证
5. **注册过程**: 向服务器注册客户端信息
6. **接收配置**: 下载爬取脚本和任务配置
7. **监控执行**: 监控页面访问并执行匹配的爬取任务

### 4.2 空闲任务流程
1. **活动检测**: 内容脚本持续监测用户活动
2. **空闲判断**: 当用户长时间无操作时判断为空闲状态
3. **后台执行**: 执行预设的后台爬取任务
4. **结果上报**: 将爬取结果发送回服务器

### 4.3 任务调度流程
1. **任务接收**: 从服务器接收定时任务配置
2. **本地缓存**: 将任务配置存储在本地
3. **定期执行**: 按照设定时间间隔执行爬取任务
4. **状态同步**: 向服务器报告任务执行状态

## 5. 数据流向

### 5.1 上行数据
- **认证信息**: 用户凭据和客户端ID
- **爬取结果**: 从网页提取的数据
- **状态信息**: 连接状态、用户活动状态
- **页面信息**: 当前访问的URL

### 5.2 下行数据
- **认证响应**: JWT令牌和认证结果
- **爬取脚本**: 服务器推送的爬取逻辑
- **任务配置**: 定时任务和执行参数
- **控制指令**: 脚本执行命令和配置更新

## 6. 安全特性

### 6.1 身份安全
- **唯一标识**: 每个浏览器实例生成唯一的客户端ID
- **指纹稳定**: 基于浏览器特征确保ID相对稳定
- **隐私保护**: 不收集敏感个人信息

### 6.2 通信安全
- **JWT认证**: 使用JWT令牌进行身份验证
- **加密传输**: WebSocket连接支持TLS加密
- **权限控制**: 严格限制扩展权限范围

### 6.3 执行安全
- **沙箱环境**: 脚本在受限环境中执行
- **输入验证**: 验证所有外部输入数据
- **错误隔离**: 防止单个脚本错误影响整体运行

## 7. 技术特点

### 7.1 扩展性
- **模块化设计**: 各功能模块松耦合设计
- **插件架构**: 支持功能扩展和定制
- **API接口**: 提供标准化接口便于集成

### 7.2 可靠性
- **错误处理**: 全面的错误捕获和处理机制
- **重连机制**: 自动重连确保服务连续性
- **状态恢复**: 异常恢复和状态同步

### 7.3 性能优化
- **缓存策略**: 本地缓存减少网络请求
- **异步处理**: 非阻塞操作提升响应速度
- **资源管理**: 有效管理内存和计算资源

## 8. 配置说明

### 8.1 权限配置
```json
{
  "permissions": [
    "storage",    // 本地存储
    "tabs",       // 标签页访问
    "alarms"      // 定时任务
  ],
  "host_permissions": [
    "<all_urls>"  // 所有URL访问权限
  ]
}
```


### 8.2 内容安全策略
- **CSP策略**: 防止XSS攻击
- **权限最小化**: 仅申请必要权限
- **数据隔离**: 用户数据安全隔离

## 9. 部署指南

### 9.1 开发环境
1. 确保Chrome浏览器版本支持MV3
2. 启用开发者模式
3. 加载解压扩展

### 9.2 生产部署
1. 打包扩展文件
2. 通过Chrome Web Store发布
3. 或侧载部署到目标环境

## 10. 故障排除

### 10.1 常见问题
- **连接失败**: 检查后端服务状态和网络连接
- **脚本不执行**: 确认域名匹配和权限设置
- **ID重复**: 验证指纹算法的唯一性

### 10.2 日志调试
- **控制台日志**: 查看background和content脚本日志
- **网络面板**: 检查WebSocket连接状态
- **存储面板**: 验证本地存储数据

---

**文档版本**: 1.0  
**最后更新**: 2026-01-28  
**适用于**: 浏览器扩展客户端 v1.0.0