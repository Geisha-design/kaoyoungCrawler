# 爬虫助手系统 - 扩展功能说明

## 空闲客户端监控功能

我们为爬虫助手系统增加了客户端空闲监控功能，该功能可以检测客户端的空闲状态（鼠标键盘无操作），并在检测到空闲时执行后台任务。

### 功能特性

#### 1. 空闲检测
- 监控用户的鼠标、键盘、触摸屏等活动
- 可配置的空闲阈值（默认5分钟）
- 实时状态更新和通知

#### 2. 后台任务执行
- 在客户端空闲时自动执行预定任务
- 支持任务排队，在空闲时集中处理
- 可配置任务仅在空闲时执行

#### 3. 状态同步
- 客户端空闲状态实时同步到后端
- 支持远程查询客户端空闲状态
- 空闲状态记录和日志

## 客户端心跳功能

系统还实现了客户端心跳机制，用于检测客户端的健康状态并自动管理客户端连接。

### 功能特性

#### 1. 心跳检测
- 客户端每30秒发送一次心跳到服务端
- 服务端记录每个客户端的最后心跳时间
- 可配置的心跳超时阈值（默认60秒）

#### 2. 健康状态管理
- 自动检测不健康的客户端（超过阈值无心跳）
- 定时任务每分钟检查一次客户端健康状态
- 自动从服务端注册列表剔除不健康的客户端

#### 3. API支持
- 提供API查询客户端健康状态
- 支持手动触发不健康客户端清理
- 实时监控在线、健康、不健康客户端数量

## 服务端定时任务管理

系统重构了定时任务管理架构，所有定时任务现在都在服务端统一管理，客户端只负责接收指令、执行任务和反馈结果。

### 架构变化

#### 1. 任务管理集中化
- 客户端不再管理任何定时任务
- 所有定时任务逻辑迁移至服务端
- 客户端只作为执行单元接收和反馈任务

#### 2. 任务调度机制
- 服务端定时检查启用的定时任务
- 根据客户端健康状态和空闲状态决定是否执行
- 通过WebSocket向客户端发送任务指令

#### 3. 客户端职责
- 接收服务端发送的任务指令
- 执行相应的爬取脚本
- 将执行结果反馈给服务端

### 技术实现

#### 浏览器插件端
1. **Content Script** (`content.js`):
   - 检测用户活动（鼠标移动、按键、滚动等）
   - 维护空闲计时器
   - 进入/退出空闲状态的通知机制
   - 后台任务执行逻辑

2. **Background Script** (`background.js`):
   - 接收空闲状态变更通知
   - 与后端WebSocket通信同步状态
   - **移除**: 客户端定时任务管理功能
   - **新增**: 专注任务执行和结果反馈
   - **新增**: 实现心跳发送机制（每30秒发送心跳消息）
   - **新增**: 连接成功后自动开始发送心跳
   - **新增**: 连接断开时停止心跳

#### 后端服务
1. **WebSocket处理器** (`CrawlerWebSocketHandler.java`):
   - 处理空闲状态更新消息
   - 更新客户端状态记录
   - **新增**: 处理心跳消息，记录最后心跳时间
   - **新增**: 维护客户端心跳时间映射表
   - **新增**: 实现客户端健康状态检查方法
   - **新增**: 实现移除不健康客户端的方法
   - **移除**: 客户端定时任务配置同步功能
   - **新增**: 任务指令发送功能

2. **定时任务服务** (`ScheduledTaskService.java`):
   - **新增**: 服务端定时任务管理
   - **新增**: 每分钟检查启用的定时任务
   - **新增**: 根据客户端状态决定是否执行任务
   - **新增**: 向客户端发送任务指令

3. **实体类扩展**:
   - `CrawlerClient`: 新增 `idleStatus` 字段
   - `CrawlerTask`: 新增 `executeOnIdle` 字段
   - `CrawlerScheduledTask`: 新增 `executeOnIdle` 字段

4. **数据库表扩展**:
   - `crawler_client`: 新增 `idle_status` 字段
   - `crawler_task`: 新增 `execute_on_idle` 字段
   - `crawler_scheduled_task`: 新增 `execute_on_idle` 字段

5. **API接口**:
   - `/api/idle/status`: 获取所有客户端空闲状态
   - `/api/idle/status/{clientId}`: 获取指定客户端空闲状态
   - `/api/idle/threshold/{clientId}`: 设置客户端空闲阈值
   - `/api/idle/check/{clientId}`: 检查客户端空闲状态
   - `/api/health/clients`: 获取所有客户端健康状态
   - `/api/health/cleanup`: 手动清理不健康客户端

6. **定时任务**:
   - **新增**: `ClientHealthCheckService`: 每分钟检查客户端健康状态
   - **新增**: 自动移除超过阈值时间无心跳的客户端
   - **新增**: `ScheduledTaskService`: 服务端定时任务管理

### 数据库变更

#### crawler_client 表
```sql
ALTER TABLE `crawler_client` ADD COLUMN `idle_status` tinyint(1) DEFAULT 0 COMMENT '空闲状态（0=忙碌，1=空闲）';
```

#### crawler_task 表
```sql
ALTER TABLE `crawler_task` ADD COLUMN `execute_on_idle` tinyint(1) DEFAULT 0 COMMENT '是否仅在空闲时执行（0=否，1=是）';
```

#### crawler_scheduled_task 表
```sql
ALTER TABLE `crawler_scheduled_task` ADD COLUMN `execute_on_idle` tinyint(1) DEFAULT 0 COMMENT '是否仅在空闲时执行（0=否，1=是）';
```

### 使用场景

1. **精准任务调度**: 只在用户不操作电脑时执行资源密集型爬取任务
2. **用户体验优化**: 避免在用户工作时执行可能影响性能的操作
3. **后台数据收集**: 在空闲时段收集非紧急数据
4. **智能任务分配**: 根据客户端空闲状态智能分配任务
5. **连接管理**: 自动检测和清理失联客户端，维护健康的客户端列表
6. **系统稳定性**: 防止因客户端异常断开导致的服务端资源泄漏
7. **集中化管理**: 所有定时任务在服务端统一调度，客户端只负责执行

### 配置选项

- `idleThreshold`: 空闲检测阈值（毫秒），默认为300000（5分钟）
- `executeOnIdle`: 任务执行策略，可设置为仅在空闲时执行
- `heartbeatInterval`: 心跳发送间隔（毫秒），默认为30000（30秒）
- `heartbeatTimeout`: 心跳超时阈值（毫秒），默认为60000（60秒）

### API示例

#### 查询客户端空闲状态
```bash
GET /api/idle/status/client_abc123
```

#### 设置空闲阈值
```bash
POST /api/idle/threshold/client_abc123
Content-Type: application/json
{
  "threshold": 600000  // 10分钟
}
```

#### 查询客户端健康状态
```bash
GET /api/health/clients
```

#### 手动清理不健康客户端
```bash
GET /api/health/cleanup
```

### 安全考虑

- 空闲状态信息仅在认证连接下传输
- 防止恶意利用空闲状态进行不当操作
- 任务执行权限验证
- 心跳频率限制，防止滥用
- 客户端执行任务时的安全沙箱

该功能增强了系统的智能化程度和稳定性，实现了任务管理的集中化，使得任务调度更加灵活和人性化，同时确保了客户端连接的健康状态。