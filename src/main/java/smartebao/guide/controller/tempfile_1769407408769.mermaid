graph TD
    A[前端请求] --> B{请求类型}
    B -->|POST /api/login| C[处理登录]
    B -->|POST /api/register| D[处理注册]
    B -->|POST /api/logout| E[处理退出登录]

    C --> F[验证用户名密码]
    F --> G{验证成功?}
    G -->|是| H[生成JWT Token]
    G -->|否| I[返回错误信息]

    H --> J[检查客户端ID]
    J --> K{客户端ID存在?}
    K -->|是| L[查找/更新客户端记录]
    K -->|否| M[继续登录流程]

    L --> N[返回成功响应<br/>包含Token]
    M --> N

    D --> O[检查用户名是否存在]
    O --> P{用户名已存在?}
    P -->|是| Q[返回冲突错误]
    P -->|否| R[创建新用户]

    R --> S[保存用户到数据库]
    S --> T[检查客户端ID]
    T --> U{客户端ID存在?}
    U -->|是| V[创建客户端记录]
    U -->|否| W[仅返回注册成功]

    V --> X[返回注册成功响应]
    W --> X
    Q --> X

    E --> Y[验证JWT令牌]
    Y --> Z{令牌有效?}
    Z -->|是| AA[获取客户端ID]
    Z -->|否| AB[返回未授权错误]

    AA --> CC{客户端ID存在?}
    CC -->|是| DD[更新客户端状态为offline]
    CC -->|否| EE[直接返回成功]

    DD --> FF[返回退出成功响应]
    EE --> FF
    AB --> FF

